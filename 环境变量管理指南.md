# 环境变量管理最佳实践

## 问题

修改 `.env` 文件后，传统方式需要重启服务器才能生效，很不方便。

## 解决方案

### 开发环境（推荐）

1. **使用开发脚本启动**
   ```bash
   ./dev.sh
   ```

2. **修改 `.env` 文件后，调用重载接口**
   ```bash
   curl -X POST http://localhost:8000/api/reload-config
   ```
   
   或者访问 http://localhost:8000/docs，找到 `/api/reload-config` 端点并执行。

3. **代码修改会自动重载**（uvicorn --reload）

### 工作原理

- **开发环境**（`ENVIRONMENT=development`）：
  - 每次请求都会重新加载 `.env` 文件
  - 支持通过 `/api/reload-config` 手动触发重载
  - 代码修改自动重载（uvicorn --reload）

- **生产环境**（`ENVIRONMENT=production`）：
  - 只在启动时加载一次，性能更好
  - `/api/reload-config` 端点被禁用（安全考虑）

## 使用示例

### 场景：切换 AI 服务类型

1. **编辑 `.env` 文件**
   ```bash
   # 从 test 切换到 deepseek
   AI_SERVICE=deepseek
   DEEPSEEK_API_KEY=your_key_here
   ```

2. **调用重载接口**（无需重启服务器）
   ```bash
   curl -X POST http://localhost:8000/api/reload-config
   ```

3. **验证配置**
   ```bash
   curl http://localhost:8000/health
   ```
   返回的 `ai_service` 字段应该显示 `deepseek`

## 启动脚本说明

- **`dev.sh`**：开发模式，支持代码自动重载和配置热重载
- **`start.sh`**：生产模式，性能优化，不支持自动重载
- **`restart_server.sh`**：重启服务器脚本（开发模式）

## 注意事项

1. 开发环境必须设置 `ENVIRONMENT=development`（`dev.sh` 会自动设置）
2. 生产环境必须设置 `ENVIRONMENT=production`（`start.sh` 会自动设置）
3. `/api/reload-config` 端点仅在开发环境中可用
4. 代码修改会自动重载，但环境变量修改需要调用重载接口
