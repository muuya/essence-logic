# 查看对话记录

系统会自动保存所有用户的问题和对应的AI回答。本文档说明如何查看这些记录。

## 数据存储位置

对话记录保存在：`data/chat_history.json`

每条记录包含：
- `timestamp`: 时间戳
- `user_message`: 用户的问题
- `assistant_message`: AI 的回答
- `client_ip`: 用户 IP 地址
- `message_count`: 对话轮数
- `user_message_length`: 用户消息长度
- `assistant_message_length`: AI 回复长度

## 查看方式

### 方法一：通过 API（开发环境）

**获取对话记录：**

开发环境可以直接访问，无需令牌：

```bash
# 获取最近 50 条记录
curl http://localhost:8000/api/chat/history

# 获取最近 20 条记录
curl http://localhost:8000/api/chat/history?limit=20

# 分页获取（跳过前10条，获取20条）
curl http://localhost:8000/api/chat/history?limit=20&offset=10
```

**注意：** 生产环境需要令牌验证，详见 [查看生产环境对话记录](./查看生产环境对话记录.md)

**在 Swagger UI 中查看：**
1. 访问：http://localhost:8000/docs
2. 找到 `/api/chat/history` 端点
3. 点击 "Try it out"
4. 设置参数（可选）
5. 点击 "Execute"

### 方法二：直接查看文件

**本地开发环境：**
```bash
# 查看文件内容
cat data/chat_history.json

# 使用 jq 格式化查看（如果安装了 jq）
cat data/chat_history.json | jq '.[-10:]'  # 查看最后10条

# 查看特定字段
cat data/chat_history.json | jq '.[] | {time: .timestamp, user: .user_message[:50], assistant: .assistant_message[:50]}'
```

**生产环境（部署后）：**
对话记录存储在服务器的 `data/chat_history.json` 文件中。如果需要查看，需要：
1. SSH 连接到服务器
2. 或者通过部署平台的文件管理功能
3. 或者添加一个管理界面（需要额外开发）

### 方法三：使用 Python 脚本

创建 `view_chat_history.py`：

```python
#!/usr/bin/env python3
"""查看对话记录"""

import json
from pathlib import Path
from datetime import datetime

CHAT_HISTORY_FILE = Path("data/chat_history.json")

def view_chat_history(limit=20):
    """查看对话记录"""
    if not CHAT_HISTORY_FILE.exists():
        print("暂无对话记录")
        return
    
    with open(CHAT_HISTORY_FILE, 'r', encoding='utf-8') as f:
        records = json.load(f)
    
    if not records:
        print("暂无对话记录")
        return
    
    print(f"总共 {len(records)} 条记录\n")
    print("=" * 80)
    
    # 显示最近的记录
    for i, record in enumerate(records[-limit:], 1):
        timestamp = record.get('timestamp', '')
        user_msg = record.get('user_message', '')[:100]
        assistant_msg = record.get('assistant_message', '')[:200]
        
        print(f"\n[{len(records) - limit + i}] {timestamp}")
        print(f"用户: {user_msg}{'...' if len(record.get('user_message', '')) > 100 else ''}")
        print(f"AI: {assistant_msg}{'...' if len(record.get('assistant_message', '')) > 200 else ''}")
        print("-" * 80)

if __name__ == "__main__":
    import sys
    limit = int(sys.argv[1]) if len(sys.argv) > 1 else 20
    view_chat_history(limit)
```

使用方法：
```bash
python view_chat_history.py 10  # 查看最近10条
```

## 数据格式示例

```json
[
  {
    "timestamp": "2026-01-21T12:00:00.123456",
    "user_message": "我想投资某个项目，但不确定是否该做",
    "assistant_message": "我理解你的犹豫。让我们先看看这件事的本质...",
    "client_ip": "192.168.1.100",
    "message_count": 1,
    "user_message_length": 20,
    "assistant_message_length": 150
  }
]
```

## 注意事项

1. **隐私保护**
   - 对话记录包含用户的实际问题
   - 请妥善保管，不要泄露
   - 生产环境建议限制访问权限

2. **存储限制**
   - 系统最多保留最近 1000 条记录
   - 超过限制会自动删除旧记录
   - 如需长期保存，请定期备份

3. **开发环境限制**
   - `/api/chat/history` 端点仅在开发环境可用
   - 生产环境需要额外配置才能访问

4. **文件位置**
   - 本地：`data/chat_history.json`
   - 部署后：服务器上的 `data/chat_history.json`

## 备份建议

定期备份对话记录：

```bash
# 备份到带时间戳的文件
cp data/chat_history.json "backups/chat_history_$(date +%Y%m%d).json"

# 或使用 Git（如果不需要版本控制，可以添加到 .gitignore）
```

## 统计分析

可以使用 Python 进行简单的统计分析：

```python
import json
from collections import Counter
from pathlib import Path

with open('data/chat_history.json', 'r', encoding='utf-8') as f:
    records = json.load(f)

# 统计总对话数
print(f"总对话数: {len(records)}")

# 统计平均消息长度
avg_user_len = sum(r['user_message_length'] for r in records) / len(records)
avg_assistant_len = sum(r['assistant_message_length'] for r in records) / len(records)
print(f"平均用户消息长度: {avg_user_len:.1f}")
print(f"平均AI回复长度: {avg_assistant_len:.1f}")

# 统计IP分布
ip_counter = Counter(r['client_ip'] for r in records)
print(f"\n访问IP分布:")
for ip, count in ip_counter.most_common(10):
    print(f"  {ip}: {count} 次")
```
