# 服务器日志管理最佳实践

## 📋 目录
1. [核心原则](#核心原则)
2. [实现方案](#实现方案)
3. [配置说明](#配置说明)
4. [使用指南](#使用指南)
5. [日志查看](#日志查看)
6. [生产环境建议](#生产环境建议)

## 🎯 核心原则

### 1. **结构化日志格式**
- ✅ 包含时间戳、日志级别、模块位置、消息内容
- ✅ 使用统一的格式便于解析和分析
- ✅ 格式：`时间戳 | 级别 | 模块:行号 | 消息`

### 2. **日志级别管理**
- **DEBUG**: 详细的调试信息（开发环境）
- **INFO**: 一般信息（请求、响应、状态变化）
- **WARNING**: 警告信息（配置问题、降级操作）
- **ERROR**: 错误信息（异常、失败操作）
- **CRITICAL**: 严重错误（系统崩溃风险）

### 3. **日志轮转（Log Rotation）**
- ✅ 防止单个日志文件过大
- ✅ 自动保留最近 N 个备份文件
- ✅ 默认配置：单个文件最大 10MB，保留 5 个备份

### 4. **分离不同级别的日志**
- ✅ `app.log`: 所有级别的日志（完整记录）
- ✅ `error.log`: 仅 ERROR 及以上级别（快速定位问题）

### 5. **多输出渠道**
- ✅ 文件日志：持久化存储，便于后续分析
- ✅ 控制台日志：开发时实时查看

### 6. **性能考虑**
- ✅ 使用标准库 `logging`（内置缓冲）
- ✅ 避免在日志中记录敏感信息（密码、token）
- ✅ 避免记录过大的数据（如完整请求体）

## 🛠️ 实现方案

### 日志文件结构
```
guide/
├── logs/
│   ├── app.log          # 所有日志
│   ├── app.log.1        # 轮转备份
│   ├── error.log        # 错误日志
│   └── error.log.1      # 错误日志备份
└── src/
    └── logger_config.py # 日志配置模块
```

### 核心功能
1. **自动创建日志目录**
2. **日志轮转管理**
3. **结构化格式**
4. **环境变量配置**
5. **请求追踪**（IP、耗时、状态码）

## ⚙️ 配置说明

### 环境变量配置

在 `.env` 文件中配置（可选）：

```bash
# 日志级别: DEBUG, INFO, WARNING, ERROR, CRITICAL
LOG_LEVEL=INFO

# 是否写入文件（true/false）
LOG_TO_FILE=true

# 是否输出到控制台（true/false）
LOG_TO_CONSOLE=true

# 日志目录（可选，默认为项目根目录下的 logs/）
LOG_DIR=/path/to/logs
```

### 代码中使用日志

```python
from logger_config import get_logger

logger = get_logger("module_name")

# 不同级别的日志
logger.debug("调试信息")
logger.info("一般信息")
logger.warning("警告信息")
logger.error("错误信息")
logger.critical("严重错误")

# 记录异常
try:
    # 代码
    pass
except Exception as e:
    logger.error(f"操作失败: {e}", exc_info=True)
```

## 📖 使用指南

### 1. 基本使用

日志系统会在应用启动时自动初始化：

```python
from src.logger_config import get_logger

logger = get_logger("main")
logger.info("应用启动")
```

### 2. 记录请求信息

已在 `main.py` 中集成：
- ✅ 自动记录所有 HTTP 请求
- ✅ 记录客户端 IP、请求路径、响应状态、耗时
- ✅ 记录聊天请求的详细信息

### 3. 记录错误

```python
try:
    # 可能出错的代码
    result = some_operation()
except Exception as e:
    logger.error(f"操作失败: {e}", exc_info=True)
    # exc_info=True 会记录完整的堆栈跟踪
```

## 🔍 日志查看

### 查看所有日志
```bash
# 实时查看
tail -f logs/app.log

# 查看最后 100 行
tail -n 100 logs/app.log

# 搜索特定内容
grep "ERROR" logs/app.log
```

### 查看错误日志
```bash
# 实时查看错误
tail -f logs/error.log

# 查看最近的错误
tail -n 50 logs/error.log
```

### 按时间过滤
```bash
# 查看今天的日志
grep "$(date +%Y-%m-%d)" logs/app.log

# 查看特定时间段的日志
grep "2024-01-15 14:" logs/app.log
```

### 使用 jq 解析 JSON（如果日志是 JSON 格式）
```bash
cat logs/app.log | jq '.'
```

## 🚀 生产环境建议

### 1. **日志聚合和分析**
- 使用 ELK Stack (Elasticsearch, Logstash, Kibana)
- 或使用云服务：AWS CloudWatch、Google Cloud Logging、Azure Monitor
- 或使用轻量级方案：Loki + Grafana

### 2. **日志监控和告警**
- 设置错误率告警（ERROR 日志超过阈值）
- 设置响应时间告警（请求耗时过长）
- 使用 Prometheus + Grafana 监控日志指标

### 3. **日志保留策略**
- 开发环境：保留 7 天
- 生产环境：保留 30-90 天
- 错误日志：保留更长时间（90-180 天）

### 4. **性能优化**
- 生产环境可以禁用 DEBUG 级别
- 使用异步日志处理（如 `python-json-logger`）
- 考虑使用结构化日志（JSON 格式）便于解析

### 5. **安全考虑**
- ❌ 不要在日志中记录：
  - 密码、API Token、密钥
  - 用户敏感信息（身份证号、银行卡号）
  - 完整的请求体（可能包含敏感数据）
- ✅ 记录：
  - 请求路径、方法、状态码
  - 错误消息（不含敏感信息）
  - 操作时间、用户 ID（非敏感）

### 6. **容器化部署**
如果使用 Docker，建议：
```dockerfile
# 使用卷挂载日志目录
VOLUME ["/app/logs"]

# 或使用日志驱动
docker run --log-driver=json-file --log-opt max-size=10m --log-opt max-file=3
```

## 📊 日志示例

### 正常请求日志
```
2024-01-15 14:30:25 | INFO     | essence_board.main:113 | 收到聊天请求 | IP: 192.168.1.100 | 消息数: 2 | 模型: deepseek | 流式: True
2024-01-15 14:30:28 | INFO     | essence_board.main:152 | 流式响应完成 | IP: 192.168.1.100 | 耗时: 2.35s
```

### 错误日志
```
2024-01-15 14:30:25 | ERROR    | essence_board.main:156 | 流式响应错误 | IP: 192.168.1.100 | 耗时: 1.20s | 错误: Connection timeout
2024-01-15 14:30:25 | DEBUG    | essence_board.main:157 | Traceback (most recent call last):
  File "src/main.py", line 128, in generate
    ...
```

## 🔧 故障排查

### 问题：日志文件没有创建
- 检查 `logs/` 目录权限
- 检查磁盘空间
- 查看应用启动日志

### 问题：日志文件过大
- 检查轮转配置（`max_bytes`、`backup_count`）
- 考虑提高日志级别（减少 DEBUG 日志）

### 问题：日志丢失
- 检查应用是否正常退出（使用 `atexit` 或信号处理）
- 检查日志缓冲区是否刷新（`logger.flush()`）

## 📚 参考资源

- [Python logging 官方文档](https://docs.python.org/3/library/logging.html)
- [FastAPI 日志最佳实践](https://fastapi.tiangolo.com/advanced/logging/)
- [12-Factor App: Logs](https://12factor.net/logs)
