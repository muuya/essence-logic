# 查看生产环境对话记录

## 重要说明

**生产环境和开发环境的数据是分离的：**

- **生产环境**：对话记录存储在部署服务器上（Koyeb 容器中）
- **开发环境**：对话记录存储在本地项目的 `data/` 目录

**生产环境的对话记录无法直接在开发环境看到。**

## 查看生产环境对话记录的方法

### 方法一：通过 API（推荐）

生产环境现在支持通过 API 查看对话记录，但需要设置访问令牌。

#### 1. 设置访问令牌

在部署时，通过环境变量设置 `ADMIN_TOKEN`：

```json
{
  "repo_url": "https://github.com/muuya/essence-logic",
  "service_name": "essence-logic",
  "branch": "main",
  "port": 8000,
  "env_vars": {
    "ENVIRONMENT": "production",
    "AI_SERVICE": "test",
    "ADMIN_TOKEN": "your_secret_token_here"
  }
}
```

#### 2. 访问对话记录 API

**推荐方式：使用 HTTP Header（更安全）**
```bash
# 使用 HTTP Header 传递令牌（推荐，更安全）
curl -H "X-Admin-Token: your_secret_token_here" \
     "https://essence-logic.ai-builders.space/api/chat/history?limit=50"
```

**兼容方式：使用查询参数**
```bash
# 使用查询参数传递令牌（兼容旧方式）
curl "https://essence-logic.ai-builders.space/api/chat/history?limit=50&token=your_secret_token_here"

# 或使用浏览器访问（替换 YOUR_TOKEN）
https://essence-logic.ai-builders.space/api/chat/history?limit=50&token=YOUR_TOKEN
```

**为什么推荐 HTTP Header 方式？**
- ✅ 令牌不会出现在 URL 中
- ✅ 不会记录在浏览器历史记录中
- ✅ 不会出现在服务器访问日志的 URL 部分
- ✅ 更符合 RESTful API 最佳实践

#### 3. 在 Swagger UI 中查看

1. 访问：https://essence-logic.ai-builders.space/docs
2. 找到 `/api/chat/history` 端点
3. 点击 "Try it out"
4. **方式一（推荐）：** 在请求头中添加 `X-Admin-Token`，值为你的 `ADMIN_TOKEN`
5. **方式二（兼容）：** 在 `token` 查询参数中输入你的 `ADMIN_TOKEN`
6. 设置 `limit` 和 `offset`（可选）
7. 点击 "Execute"

**注意：** Swagger UI 中设置 Header 的方法：
- 在 Swagger UI 页面顶部找到 "Authorize" 按钮
- 或直接在请求参数区域找到 Headers 部分
- 添加 Header：`X-Admin-Token: your_token_here`

### 方法二：通过部署日志

查看部署日志可能包含一些信息，但不会包含完整的对话记录。

```bash
# 查看部署日志
python deploy.py --status essence-logic
```

### 方法三：通过 Koyeb 控制台（如果可用）

如果 Koyeb 提供了文件访问功能，可以：
1. 登录 Koyeb 控制台
2. 找到你的服务
3. 查看容器文件系统
4. 访问 `/app/data/chat_history.json`

## 安全建议

1. **使用强密码作为 ADMIN_TOKEN**
   - 至少 32 个字符
   - 包含大小写字母、数字和特殊字符
   - 不要提交到 Git

2. **定期轮换令牌**
   - 每 3-6 个月更换一次
   - 更新部署配置中的 `ADMIN_TOKEN`

3. **限制访问**
   - 不要公开分享 `ADMIN_TOKEN`
   - 只在需要时访问对话记录

## 开发环境 vs 生产环境

| 特性 | 开发环境 | 生产环境 |
|------|---------|---------|
| 数据存储位置 | 本地 `data/chat_history.json` | 服务器 `/app/data/chat_history.json` |
| API 访问 | 无需令牌 | 需要 `ADMIN_TOKEN` |
| 数据同步 | ❌ 不同步 | ❌ 不同步 |
| 查看方式 | 直接访问 API 或文件 | 通过 API + 令牌 |

## 推荐方案

**最佳实践：**

1. **开发测试**：在本地开发环境测试对话记录功能
2. **生产监控**：设置 `ADMIN_TOKEN`，通过 API 定期查看生产环境对话记录
3. **数据备份**：定期导出生产环境的对话记录进行备份

**示例脚本：**

```python
#!/usr/bin/env python3
"""导出生产环境对话记录"""

import requests
import json
from datetime import datetime

ADMIN_TOKEN = "your_secret_token_here"
API_URL = "https://essence-logic.ai-builders.space/api/chat/history"

def export_chat_history():
    """导出对话记录（使用 HTTP Header，推荐方式）"""
    all_records = []
    offset = 0
    limit = 100
    
    # 使用 HTTP Header 传递令牌（推荐）
    headers = {
        "X-Admin-Token": ADMIN_TOKEN
    }
    
    while True:
        response = requests.get(
            API_URL,
            headers=headers,  # 使用 Header 传递令牌
            params={"limit": limit, "offset": offset}
        )
        response.raise_for_status()
        data = response.json()
        
        records = data.get("records", [])
        if not records:
            break
        
        all_records.extend(records)
        
        if len(records) < limit:
            break
        
        offset += limit
    
    # 保存到文件
    filename = f"chat_history_export_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(all_records, f, ensure_ascii=False, indent=2)
    
    print(f"✅ 已导出 {len(all_records)} 条记录到 {filename}")
    return filename

# 兼容方式：使用查询参数（不推荐，但可用）
def export_chat_history_query_param():
    """导出对话记录（使用查询参数，兼容方式）"""
    all_records = []
    offset = 0
    limit = 100
    
    while True:
        response = requests.get(
            API_URL,
            params={"limit": limit, "offset": offset, "token": ADMIN_TOKEN}
        )
        response.raise_for_status()
        data = response.json()
        
        records = data.get("records", [])
        if not records:
            break
        
        all_records.extend(records)
        
        if len(records) < limit:
            break
        
        offset += limit
    
    filename = f"chat_history_export_{datetime.now().strftime('%Y%m%d_%H%M%S')}.json"
    with open(filename, 'w', encoding='utf-8') as f:
        json.dump(all_records, f, ensure_ascii=False, indent=2)
    
    print(f"✅ 已导出 {len(all_records)} 条记录到 {filename}")
    return filename

if __name__ == "__main__":
    export_chat_history()  # 使用推荐方式
```

## 总结

- ❌ **不能**直接在开发环境看到生产环境的对话记录
- ✅ **可以**通过 API + 访问令牌查看生产环境对话记录
- ✅ **建议**设置 `ADMIN_TOKEN` 并定期导出备份
