# 部署指南

本指南介绍如何将"本质看板"项目部署到 AI Builders Space。

## 前置要求

1. **AI Builders Token**
   - 确保已获取有效的 `AI_BUILDER_TOKEN`
   - 设置环境变量：`export AI_BUILDER_TOKEN='your_token_here'`
   - 或在 `.env` 文件中配置

2. **项目依赖**
   - 确保已安装所有依赖：`uv sync`
   - 确保项目可以正常运行：`./dev.sh` 测试本地运行

## 快速部署

### 1. 基本部署

使用默认配置部署：

```bash
python deploy.py
```

或使用可执行脚本：

```bash
./deploy.py
```

### 2. 使用自定义配置

创建配置文件 `deploy.config.json`（可参考 `deploy.config.example.json`）：

```json
{
  "name": "essence-logic",
  "display_name": "本质看板",
  "description": "基于段永平'本分'与'平常心'哲学的本质看板系统",
  "version": "4.0.0",
  "environment": "production"
}
```

然后使用配置文件部署：

```bash
python deploy.py --config deploy.config.json
```

### 3. 指定项目名称

```bash
python deploy.py --project-name my-essence-logic
```

## 部署选项

### 不等待部署完成

默认情况下，部署脚本会等待部署完成。如果不想等待：

```bash
python deploy.py --no-wait
```

### 设置超时时间

默认超时时间为 300 秒（5分钟），可以自定义：

```bash
python deploy.py --timeout 600
```

## 部署管理

### 列出所有部署

```bash
python deploy.py --list
```

### 查询部署状态

```bash
python deploy.py --status <deployment_id>
```

## 部署流程

1. **准备阶段**
   - 检查环境变量和配置
   - 加载项目配置
   - 验证 AI Builders Token

2. **上传阶段**
   - 打包项目文件
   - 上传到 AI Builders Space
   - 获取部署ID

3. **等待阶段**（如果使用 `--wait`）
   - 定期查询部署状态
   - 显示进度信息
   - 等待部署完成或超时

4. **完成阶段**
   - 显示部署结果
   - 提供访问地址（如果可用）

## 环境变量配置

部署时，确保以下环境变量已正确设置：

```bash
# AI Builders Token（必需）
export AI_BUILDER_TOKEN='your_token_here'

# AI Builders API 基础URL（可选，默认值已设置）
export AI_BUILDER_BASE_URL='https://space.ai-builders.com/backend'

# AI 服务类型（可选）
export AI_SERVICE='test'  # 或 'deepseek'

# 如果是 DeepSeek 模式
export DEEPSEEK_API_KEY='your_deepseek_key'
```

## 故障排查

### 1. Token 错误

**错误信息：** `未设置 AI_BUILDER_TOKEN 环境变量`

**解决方案：**
```bash
export AI_BUILDER_TOKEN='your_token_here'
# 或添加到 .env 文件
echo "AI_BUILDER_TOKEN=your_token_here" >> .env
```

### 2. 部署端点未找到

**错误信息：** `部署失败：无法找到有效的部署端点`

**可能原因：**
- AI Builders API 端点路径可能不同
- Token 权限不足
- API 版本更新

**解决方案：**
- 检查 AI Builders 文档确认正确的端点
- 联系 AI Builders 支持获取最新 API 文档
- 检查 Token 权限

### 3. 部署超时

**错误信息：** `超时: 部署未在 X 秒内完成`

**解决方案：**
- 增加超时时间：`--timeout 600`
- 使用 `--no-wait` 不等待，稍后手动查询状态
- 检查网络连接和服务器状态

### 4. 部署失败

**错误信息：** `部署失败: ...`

**解决方案：**
- 查看详细错误信息
- 检查项目配置是否正确
- 确认所有必需文件都已包含
- 检查日志文件获取更多信息

## 部署后验证

部署完成后，建议进行以下验证：

1. **健康检查**
   ```bash
   curl https://your-deployment-url/health
   ```

2. **API 测试**
   ```bash
   curl -X POST https://your-deployment-url/api/chat \
     -H "Content-Type: application/json" \
     -d '{"messages": [{"role": "user", "content": "测试"}], "model": "deepseek"}'
   ```

3. **前端访问**
   - 在浏览器中打开部署地址
   - 测试基本功能

## 注意事项

1. **敏感信息**
   - 不要将 `.env` 文件提交到 Git
   - 确保 Token 和 API Key 安全

2. **版本管理**
   - 建议使用版本号标记每次部署
   - 保留部署记录以便回滚

3. **资源限制**
   - 注意 AI Builders Space 的资源限制
   - 监控部署后的资源使用情况

4. **备份**
   - 部署前备份重要数据
   - 保留本地项目副本

## 相关文件

- `deploy.py` - 部署脚本
- `deploy.config.example.json` - 配置示例
- `README.md` - 项目文档
- `.env` - 环境变量配置（不提交到 Git）

## 获取帮助

如果遇到问题：

1. 查看本文档的故障排查部分
2. 检查项目日志：`logs/app.log`
3. 查看 AI Builders 文档
4. 联系 AI Builders 支持
