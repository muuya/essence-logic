# 用户反馈和使用场景收集功能说明

## 功能概述

根据 MVP 评估报告的建议，已实现以下两个核心功能：

1. **用户反馈机制**：在每个 AI 回复后收集用户反馈
2. **使用场景收集**：首次使用时收集用户的使用场景

---

## 功能详情

### 1. 用户反馈机制

#### 反馈类型
- **映射准确性**：AI 是否准确识别了用户的情绪和处境
- **建议有用性**：AI 的建议是否有用

#### 反馈方式
- 每个 AI 回复后，会显示两个反馈区域
- 用户可以通过 1-5 星评分（点击数字按钮）
- 反馈会实时提交到后端并保存

#### 数据存储
- 反馈数据保存在 `data/feedback.json`
- 包含时间戳、消息ID、反馈类型、评分等信息

---

### 2. 使用场景收集

#### 场景类型
- **决策前夕**：感到兴奋或不安，需要理清动机
- **事后复盘**：无论成败，希望从中提炼出符合"本分"的经验
- **心境波动**：察觉到自己被外界评价或短期得失影响时

#### 收集方式
- 首次访问时，会弹出场景选择对话框
- 用户选择一个场景后，信息会保存到 localStorage
- 场景数据会提交到后端并保存

#### 数据存储
- 场景数据保存在 `data/scenarios.json`
- 包含时间戳、场景类型等信息

---

## API 端点

### 提交反馈
```bash
POST /api/feedback
Content-Type: application/json

{
  "message_id": "消息ID",
  "feedback_type": "mapping_accuracy" | "suggestion_usefulness",
  "rating": 1-5,
  "comment": "可选评论"
}
```

### 提交场景
```bash
POST /api/scenario
Content-Type: application/json

{
  "scenario": "decision_before" | "review_after" | "mood_fluctuation",
  "user_question_type": "可选的问题类型"
}
```

### 查看统计（仅开发环境）
```bash
GET /api/feedback/stats
```

返回反馈统计信息，包括：
- 总反馈数
- 映射准确性平均评分
- 建议有用性平均评分
- 各场景使用次数

---

## 数据文件

### 反馈数据格式 (`data/feedback.json`)
```json
[
  {
    "timestamp": "2026-01-20T10:30:00",
    "message_id": "1234567890",
    "feedback_type": "mapping_accuracy",
    "rating": 5,
    "comment": null,
    "ip": "127.0.0.1"
  }
]
```

### 场景数据格式 (`data/scenarios.json`)
```json
[
  {
    "timestamp": "2026-01-20T10:30:00",
    "scenario": "decision_before",
    "user_question_type": null,
    "ip": "127.0.0.1"
  }
]
```

---

## 使用说明

### 用户端
1. **首次使用**：打开页面时会弹出场景选择对话框，选择一个场景
2. **反馈**：每个 AI 回复后，在消息下方可以看到反馈按钮
3. **评分**：点击 1-5 数字按钮进行评分，按钮会高亮显示

### 开发者端
1. **查看反馈数据**：查看 `data/feedback.json` 文件
2. **查看场景数据**：查看 `data/scenarios.json` 文件
3. **查看统计**：在开发环境中访问 `GET /api/feedback/stats`

---

## 注意事项

1. **数据隐私**：反馈数据包含 IP 地址，注意隐私保护
2. **数据目录**：`data/` 目录已在 `.gitignore` 中，不会被提交到 Git
3. **开发环境**：统计接口仅在开发环境中可用
4. **localStorage**：场景选择会保存到浏览器 localStorage，避免重复询问

---

## 后续优化建议

1. **数据分析面板**：创建可视化面板展示反馈统计
2. **反馈导出**：支持导出反馈数据为 CSV 格式
3. **反馈提醒**：如果用户多次未反馈，可以添加提醒
4. **反馈分析**：分析反馈数据，识别系统提示词需要优化的地方
